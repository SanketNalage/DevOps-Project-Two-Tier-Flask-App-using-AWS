#!groovy
pipeline {
    agent any

    environment {
        EC2_IP      = '65.0.139.32'
        EC2_USER    = 'ubuntu'
        REPO_URL    = 'https://github.com/SanketNalage/DevOps-Project-Two-Tier-Flask-App-using-AWS.git'
        SSH_CRED_ID = 'ec2-ssh-key'
        PROJECT_DIR = '/home/ubuntu/student-app'
    }

    stages {
        stage('Check Connectivity') {
            steps {
                sshagent([SSH_CRED_ID]) {
                    sh "ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} 'echo Connection Successful! Server is ready.'"
                }
            }
        }

        stage('Update Code on Server') {
            steps {
                sshagent([SSH_CRED_ID]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                            # 1. Create directory if it does not exist
                            mkdir -p ${PROJECT_DIR}
                            cd ${PROJECT_DIR}

                            # 2. Check if git is already initialized
                            if [ -d ".git" ]; then
                                echo "Repository exists. Pulling latest changes..."
                                git reset --hard
                                git pull origin main
                            else
                                echo "First time deployment. Cloning repository..."
                                git clone ${REPO_URL} .
                            fi
                        '
                    """
                }
            }
        }

        stage('Build & Deploy') {
            steps {
                sshagent([SSH_CRED_ID]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                            cd ${PROJECT_DIR}

                            # Bring down current stack (same compose project)
                            sudo docker compose down --remove-orphans || true

                            # Extra safety: remove any old mysql-db container with same name
                            echo "Cleaning up any old mysql-db container..."
                            sudo docker rm -f mysql-db || true

                            echo "Building and Starting Containers..."
                            sudo docker compose up -d --build --remove-orphans
                        '
                    """
                }
            }
        }

        stage('Cleanup (Free Tier Saver)') {
            steps {
                sshagent([SSH_CRED_ID]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                            echo "Cleaning up old images to save disk space..."
                            sudo docker system prune -f
                        '
                    """
                }
            }
        }
    }
}
